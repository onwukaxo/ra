import { Link, NavLink, useNavigate } from 'react-router-dom'
import { useAuth } from '../context/AuthContext'
import { useCart } from '../context/CartContext'
import { useState, useEffect } from 'react'
import { ShoppingCart } from 'lucide-react'
import CartDrawer from './CartDrawer'
import logo from '../assets/logo.png'

const navLinkClasses = ({ isActive }) =>
  `px-3 py-1 text-sm font-medium rounded-full transition-colors ${
    isActive ? ' text-[#12343A] text-xl' : 'text-slate-700 hover:text-xl'
  }`

export default function Navbar() {
  const { user, logout } = useAuth()
  const { items } = useCart()
  const [open, setOpen] = useState(false)        // mobile menu
  const [cartOpen, setCartOpen] = useState(false) // cart drawer
  const navigate = useNavigate()

  const handleOpenCart = () => {
    setCartOpen(true)
    window.dispatchEvent(new CustomEvent('cart-opened'))
  }
  const handleCloseCart = () => {
    setCartOpen(false)
    window.dispatchEvent(new CustomEvent('cart-closed'))
  }

  useEffect(() => {
    const open = () => handleOpenCart()
    window.addEventListener('open-cart', open)
    return () => window.removeEventListener('open-cart', open)
  }, [])

  // count of all items in cart
  const cartCount = items.reduce((sum, item) => sum + (item.quantity > 0 ? item.quantity : 0), 0)
  const hasCart = cartCount > 0

  return (
    <>
      <header className="sticky top-0 z-50 w-full border-b border-black/10 bg-[#FDCD2F] shadow-sm">
        <nav className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
          {/* Logo */}
          <Link to="/" className="flex items-center gap-2">
            <img src={logo} alt="Rations Logo" className="h-8 w-8 object-contain" />
            <span className="font-semibold text-lg">Rations</span>
          </Link>

          {/* Desktop nav links */}
          <div className="hidden md:flex items-center gap-4">
            <NavLink to="/" className={navLinkClasses}>Home</NavLink>
            <NavLink to="/menu" className={navLinkClasses}>Menu</NavLink>
            <NavLink to="/community" className={navLinkClasses}>Community</NavLink>
            <NavLink to="/contact" className={navLinkClasses}>Contact</NavLink>
            {user && (
              <>
                <NavLink to="/orders" className={navLinkClasses}>My Orders</NavLink>
              </>
            )}
          </div>

          {/* Right side actions (cart + auth + hamburger) */}
          <div className="flex items-center gap-3">
            {/* Cart button - visible on all screen sizes */}
            {hasCart && (
              <button
                type="button"
                onClick={handleOpenCart}
                className="relative p-2 rounded-full border border-slate-300 bg-white hover:bg-slate-100"
                aria-label="Open cart"
              >
                <ShoppingCart className="w-5 h-5 text-[#0C1E22]" />
                {hasCart && (
                  <span className="absolute -top-1 -right-1 min-w-[18px] h-[18px] rounded-full bg-red-600 text-white text-[10px] flex items-center justify-center font-bold">
                    {cartCount}
                  </span>
                )}
              </button>
            )}

            {/* Desktop auth buttons */}
            <div className="hidden md:flex items-center gap-3">
              {user ? (
                <>
<Link to={user.role === 'ADMIN' ? '/admin' : '/dashboard'} className="text-sm text-slate-700 hover:underline">Hi, {user.name}</Link>                  <button
                    onClick={logout}
                    className="text-sm px-3 py-2 rounded-full  bg-red-600 text-white border-slate-200 hover:bg-red-700"
                  >
                    Logout
                  </button>
                </>
              ) : (
                <>
                  <button
                    onClick={() => navigate('/login')}
                    className=" text-sm px-3 py-2 rounded-full bg-ration-dark text-white hover:bg-ration-dark-hover"
                  >
                    Login
                  </button>
                  <button
                    onClick={() => navigate('/register')}
                    className="text-sm px-3 py-2 rounded-full bg-ration-dark text-white hover:bg-ration-dark-hover"
                  >
                    Sign Up
                  </button>
                </>
              )}
            </div>

            {/* Mobile hamburger - separate from cart */}
            <button
              className="md:hidden p-2 rounded-md border text-[#0C1E22]"
              onClick={() => setOpen(!open)}
              aria-label="Toggle menu"
            >
              â˜°
            </button>
          </div>
        </nav>

        {/* Mobile dropdown menu */}
        {open && (
          <div className="md:hidden border-t bg-white px-4 py-3 flex flex-col gap-2">
            <NavLink to="/" onClick={() => setOpen(false)} className={navLinkClasses}>Home</NavLink>
            <NavLink to="/menu" onClick={() => setOpen(false)} className={navLinkClasses}>Menu</NavLink>
            <NavLink to="/community" onClick={() => setOpen(false)} className={navLinkClasses}>Community</NavLink>

            {user && (
              <>
                <NavLink to="/orders" onClick={() => setOpen(false)} className={navLinkClasses}>My Orders</NavLink>
                {user.role === 'ADMIN' && (
                  <NavLink to="/admin" onClick={() => setOpen(false)} className={navLinkClasses}>Admin</NavLink>
                )}
              </>
            )}
            <NavLink to="/contact" onClick={() => setOpen(false)} className={navLinkClasses}>Contact</NavLink>

            <div className="mt-2 flex gap-2">
              {user ? (
                <button
                  onClick={() => { setOpen(false); logout(); }}
                  className="flex-1 text-sm px-3 py-2 rounded-full border bg-red-600 text-white border-slate-200 hover:bg-red-700"
                >
                  Logout
                </button>
              ) : (
                <>
                  <button
                    onClick={() => { setOpen(false); navigate('/login'); }}
                    className="flex-1 text-sm px-3 py-2 rounded-full border border-slate-200 hover:bg-slate-100"
                  >
                    Login
                  </button>
                  <button
                    onClick={() => { setOpen(false); navigate('/register'); }}
                    className="flex-1 text-sm px-3 py-2 rounded-full bg-primary-500 text-white hover:bg-primary-600"
                  >
                    Sign Up
                  </button>
                </>
              )}
            </div>
          </div>
        )}
      </header>

      {/* Cart drawer hooked up */}
      <CartDrawer
        open={cartOpen}
        onClose={handleCloseCart}
        items={items}
      />
    </>
  )
}
